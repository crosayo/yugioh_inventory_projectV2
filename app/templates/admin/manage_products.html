{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>製品マスタ管理</h2>
        <a href="{{ url_for('admin.add_product') }}" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
            </svg>
            新規製品を登録
        </a>
    </div>

    <form method="GET" action="{{ url_for('admin.manage_products') }}" class="row g-3 align-items-end mb-4 p-3 bg-light border rounded">
        <div class="col-12 col-md-6">
            <label for="keyword" class="form-label">キーワード検索:</label>
            <div class="input-group">
                <input type="text" name="keyword" id="keyword" class="form-control" placeholder="製品名、表示名で検索" value="{{ keyword or '' }}">
                <button type="submit" class="btn btn-outline-secondary">検索</button>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <label class="form-label">ソート:</label>
            <div class="input-group">
                <select name="sort_key" class="form-select" onchange="this.form.submit()">
                    <option value="release_date" {% if sort_key == 'release_date' %}selected{% endif %}>発売日</option>
                    <option value="name" {% if sort_key == 'name' %}selected{% endif %}>製品名</option>
                    <option value="era" {% if sort_key == 'era' %}selected{% endif %}>期</option>
                </select>
                <select name="sort_order" class="form-select" onchange="this.form.submit()">
                    <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>降順</option>
                    <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>昇順</option>
                </select>
            </div>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-sm">
            <thead class="table-light">
                <tr>
                    <th>製品名</th>
                    <th>表示名</th>
                    <th>発売日</th>
                    <th class="text-center">期</th>
                    <th class="text-center">サイドバー表示</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for p in products %}
                <tr>
                    <td>{{ p.name }}</td>
                    <td>{{ p.display_name }}</td>
                    <td>{{ p.release_date.strftime('%Y-%m-%d') if p.release_date else '---' }}</td>
                    <td class="text-center">{{ p.era or '?' }}</td>
                    <td class="text-center">
                        {# ===== ここから変更 ===== #}
                        <form action="{{ url_for('admin.toggle_sidebar_visibility', product_name=p.name|urlencode) }}" method="POST" class="d-inline">
                            {% if p.show_in_sidebar %}
                                <button type="submit" class="btn btn-success btn-sm" title="クリックして非表示にする">表示中</button>
                            {% else %}
                                <button type="submit" class="btn btn-secondary btn-sm" title="クリックして表示する">非表示</button>
                            {% endif %}
                        </form>
                        {# ===== ここまで変更 ===== #}
                    </td>
                    <td>
                        <a href="{{ url_for('admin.edit_product', product_name=p.name|urlencode) }}" class="btn btn-outline-primary btn-sm">編集</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}